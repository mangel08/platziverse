{"version":3,"sources":["metric-test.js"],"names":["test","require","sinon","proxyquire","metricFixtures","config","logging","AgentStub","hasMany","spy","uuid","type","MetricStub","db","sandbox","typeArgs","where","uuidArgs","single","Object","assign","newMetric","value","beforeEach","createSandbox","belongsTo","create","stub","withArgs","returns","Promise","resolve","toJSON","findAll","byAgentUuid","byType","setupDatabase","afterEach","restore","t","truthy","Metric","serial","true","called","calledWith","metric","calledOnce","deepEqual"],"mappings":"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","file":"metric-test.js","sourcesContent":["'use strict'\n\nconst test = require('ava')\nconst sinon = require('sinon')\nconst proxyquire = require('proxyquire')\nconst metricFixtures = require('./fixtures/metric')\n\nlet config = {\n  logging: function () { }\n}\n\nlet AgentStub = {\n  hasMany: sinon.spy()\n}\n\n// Argumentos para testear\nlet uuid = 'yyy-yyy-yyy'\nlet type = 'RAM'\nlet MetricStub = null\nlet db = null\nlet sandbox = null\n\nlet typeArgs = {\n  where: { type }\n}\n\nlet uuidArgs = { uuid }\n\nlet single = Object.assign({}, metricFixtures.single) // Creando un objeto metric falso\n\nlet newMetric = {\n  type: 'RAM',\n  value: '60 MB'\n}\n\ntest.beforeEach(async () => {\n  sandbox = sinon.createSandbox()\n  MetricStub = {\n    belongsTo: sandbox.spy()\n  }\n\n  // Metric Create Stub\n  MetricStub.create = sandbox.stub()\n  MetricStub.create.withArgs(newMetric).returns(Promise.resolve({ toJSON () { return newMetric } }))\n\n  // Metric FindAll Stub\n  MetricStub.findAll = sandbox.stub()\n  MetricStub.findAll.withArgs(AgentStub.uuid).returns(Promise.resolve(metricFixtures.byAgentUuid))\n  MetricStub.findAll.withArgs(typeArgs).returns(Promise.resolve(metricFixtures.byType))\n\n  const setupDatabase = proxyquire('../', {\n    './models/agent': () => AgentStub,\n    './models/metric': () => MetricStub\n  })\n\n  db = await setupDatabase(config)\n})\n\ntest.afterEach(() => {\n  sandbox && sandbox.restore()\n})\n\ntest('Metric', t => {\n  t.truthy(db.Metric, 'Metric service should exist')\n})\n\ntest('Agent', t => {\n  t.truthy(db.Metric, 'Agent service should exist')\n})\n\ntest.serial('Setup', t => {\n  t.true(AgentStub.hasMany.called, 'AgentModel.HasMany was executed')\n  t.true(AgentStub.hasMany.calledWith(MetricStub), 'Argument should be the Metricmodel')\n  t.true(MetricStub.belongsTo.called, 'MetricModel.belongsTo was executed')\n  t.true(MetricStub.belongsTo.calledWith(AgentStub), 'Argument should be the Agentmodel')\n})\n\ntest.serial('Metric#Create', async t => {\n  let metric = await db.Metric.create(uuid, single)\n\n  // t.true(AgentStub.findOne.called, 'findOne should be called on AgentModel')\n  // t.true(AgentStub.findOne.calledOnce, 'findOne should be called once')\n  // t.true(AgentStub.findOne.calledWith(uuidArgs), 'findOne should be called with uuidArgs')\n  t.true(MetricStub.create.called, 'create should be called on model')\n  t.true(MetricStub.create.calledOnce, 'create should be called once')\n  t.true(MetricStub.create.calledWith(newMetric), 'create should be called with args newAgent')\n\n  t.deepEqual(metric, newMetric, 'metric should be the same')\n})\n"]}